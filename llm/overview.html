<!DOCTYPE html><html><head>
      <title>overview</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/aaron/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.19/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}@font-face{font-family:"Material Icons";font-style:normal;font-weight:400;src:local("Material Icons"),local("MaterialIcons-Regular"),url("data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAAfIAAsAAAAADDAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFZW7kosY21hcAAAAYAAAADTAAACjtP6ytBnbHlmAAACVAAAAxgAAAQ4zRtvlGhlYWQAAAVsAAAALwAAADYRwZsnaGhlYQAABZwAAAAcAAAAJAeKAzxobXR4AAAFuAAAABIAAAA8OGQAAGxvY2EAAAXMAAAAIAAAACAG5AfwbWF4cAAABewAAAAfAAAAIAEfAERuYW1lAAAGDAAAAVcAAAKFkAhoC3Bvc3QAAAdkAAAAYgAAAK2vz7wkeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2BkPsQ4gYGVgYOpk+kMAwNDP4RmfM1gxMjBwMDEwMrMgBUEpLmmMDgwVLy4xKzzX4chhrmK4QpQmBEkBwAZygyweJzFkr0NwjAQhZ+TEP6CRUfHBEwRUWaQTICyQbpMwRCskA5RUIONxG0RnnNpKAIV4qzPku/8c353ACYAYrIjCWCuMAh2ptf0/hiL3p/gyPUWa3osqlt0L1zu9r71z8dGrJRykFoauXQd932Lj5vhG+MjxGeYI8MKETObMpslf5EyP8tg+vHun5r539PvlvXzaVhRFVQDTPEWKVQR90KhnnC5Ek67vUKN4VuFasM/ldARj43CCkCsEjpJSoVVgRyU0GVSK6wUpFFCx8lFgX0BiXpRPQB4nE2TTWjcRhTH3xttpDhxN7uxPlp3u/FK7moRPixafRijNosxSw/LUsIwNcaEHPZggo/FmEKMCKWU4kNOOftQSlhE8alnH0Ix9BqWnHooPRrTQ0+mnu2bXTu2pPdGM9LM/6c3fwECTM4gBBMYQNqxzLrZAjqYSlqu2TAHZQA0/DQJH6FtzqGDnvbt4Ggwvzw/nL8EfH8kW0fsuRqhgWXZnY7M1picaUL7Du5BHeDzMIl83dAt016wH1qmvtSMo5R6YRJHTR//FXsff/nj/tc/5K9P5d+nP22+fFK5u7v3K39SW3y+OtDKO3L85vD09PD9z5X17a2N1g4tqk01RlqX7gyoEmnsWQtVr4rtZMmukEaFBZxzefkCn11cyKMLZgshRwgTYNoLNXCBz2ja7HvZG7hDpPSNfoo5vs0knK/9hb+rNpu+8kHPgk/Ao4kK3tWtTpSEtvkA9c+wE6UaUdwieNkaHg55tBEtRiEPw1s0+FtrtTcc9two2lhMknV7PZF/cs6+uUFTmpTGbEx7sQCPSLOttHS3GRltqp7SNzVSKzl6aWnZT/CX5k6/v9N3Hh8fHBwffJVjhrC6OgH5dkIt/tPsq+d/PD5Qz7G7efzq1THFjdZVPe/N6ulQ3JnDWSE5junsFsVIiFwL/htf1S5gJ3BfOcUxfHKLnzqpFpyfZ9cX+/5WB6a+Y0pHpzkNrYNVDwMsikK+y7WuLCRg/oFHkA8VT3rDg5ZnU6ktzzINymV0m74Xd5pfIGXyFeVEQSShkzqG7TBBa2OxVRKitLXv7h3uuftXnXq7lz2tZ/WnWa9dx9dCjDhHzmuVQATlmljr9dZErUydSo2Hbi/b1vXtrOeGCk2/8s3ZlO8+ueJT8BVlw5pGw2oYccdSiHHqx0RlabHqdNR9jAETl6PreJcPBnnfpTLnOQ8C3OV8AmQGzouV1iZdeb5SSIoVc8W8/kcDtksUH5FrU6/aqBqNWcMEzxG4DAQ14qRQhi9mWU0rzepKezbjfgCwQKxVYq5ajRgpRqy45CqwkJydcEkbTkvRz8P5/2ZpDTN4nGNgZGBgAOKb6v+/xvPbfGXgZmEAgeuB2kkI+v8bFgbmKiCXg4EJJAoAPyAKhQB4nGNgZGBg1vmvwxDDwgACQJKRARXwAwAzZQHQeJxjYQCCFAYGFgbSMQAcWACdAAAAAAAAAAwALgBgAIQAmADSAQgBIgE8AVABoAHeAfwCHHicY2BkYGDgZ7BgYGMAASYg5gJCBob/YD4DAA/hAWQAeJxlkbtuwkAURMc88gApQomUJoq0TdIQzEOpUDokKCNR0BuzBiO/tF6QSJcPyHflE9Klyyekz2CuG8cr7547M3d9JQO4xjccnJ57vid2cMHqxDWc40G4Tv1JuEF+Fm6ijRfhM+oz4Ra6eBVu4wZvvMFpXLIa40PYQQefwjVc4Uu4Tv1HuEH+FW7i1mkKn6Hj3Am3sHC6wm08Ou8tpSZGe1av1PKggjSxPd8zJtSGTuinyVGa6/Uu8kxZludCmzxMEzV0B6U004k25W35fj2yNlCBSWM1paujKFWZSbfat+7G2mzc7weiu34aczzFNYGBhgfLfcV6iQP3ACkSaj349AxXSN9IT0j16JepOb01doiKbNWt1ovippz6sVYYwsXgX2rGVFIkq7Pl2PNrI6qW6eOshj0xaSq9mpNEZIWs8LZUfOouNkVXxp/d5woqebeYIf4D2J1ywQB4nG3LOw6AIBAE0B384B+PAkgEa+QwNnYmHt+EpXSal5lkSBBnoP8oCFSo0aCFRIceA0ZMmLFAYSW88rmvtMUjG3RiQ9HvpfusM6zWNmtc5H/iPewha50tOt5PS/QBx2IeSwAA") format("woff")}.admonition{box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2);position:relative;margin:1.5625em 0;padding:0 1.2rem;border-left:.4rem solid rgba(68,138,255,.8);border-radius:.2rem;background-color:rgba(255,255,255,.05);overflow:auto}.admonition>p{margin-top:.8rem}.admonition>.admonition-title{margin:0 -1.2rem;padding:.8rem 1.2rem .8rem 3.6rem;border-bottom:1px solid rgba(68,138,255,.2);background-color:rgba(68,138,255,.1);font-weight:700}.admonition>.admonition-title:before{position:absolute;left:1.2rem;font-size:1.5rem;color:rgba(68,138,255,.8);content:"\E3C9"}.admonition>.admonition-title:before{font-family:Material Icons;font-style:normal;font-variant:normal;font-weight:400;line-height:2rem;text-transform:none;white-space:nowrap;speak:none;word-wrap:normal;direction:ltr}.admonition.abstract,.admonition.summary,.admonition.tldr{border-left-color:rgba(0,176,255,.8)}.admonition.abstract>.admonition-title,.admonition.summary>.admonition-title,.admonition.tldr>.admonition-title{background-color:rgba(0,176,255,.1);border-bottom-color:rgba(0,176,255,.2)}.admonition.abstract>.admonition-title:before,.admonition.summary>.admonition-title:before,.admonition.tldr>.admonition-title:before{color:#00b0ff;content:"\E8D2"}.admonition.hint,.admonition.tip{border-left-color:rgba(0,191,165,.8)}.admonition.hint>.admonition-title,.admonition.tip>.admonition-title{background-color:rgba(0,191,165,.1);border-bottom-color:rgba(0,191,165,.2)}.admonition.hint>.admonition-title:before,.admonition.tip>.admonition-title:before{color:#00bfa5;content:"\E80E"}.admonition.info,.admonition.todo{border-left-color:rgba(0,184,212,.8)}.admonition.info>.admonition-title,.admonition.todo>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.info>.admonition-title:before,.admonition.todo>.admonition-title:before{color:#00b8d4;content:"\E88E"}.admonition.check,.admonition.done,.admonition.success{border-left-color:rgba(0,200,83,.8)}.admonition.check>.admonition-title,.admonition.done>.admonition-title,.admonition.success>.admonition-title{background-color:rgba(0,200,83,.1);border-bottom-color:rgba(0,200,83,.2)}.admonition.check>.admonition-title:before,.admonition.done>.admonition-title:before,.admonition.success>.admonition-title:before{color:#00c853;content:"\E876"}.admonition.faq,.admonition.help,.admonition.question{border-left-color:rgba(100,221,23,.8)}.admonition.faq>.admonition-title,.admonition.help>.admonition-title,.admonition.question>.admonition-title{background-color:rgba(100,221,23,.1);border-bottom-color:rgba(100,221,23,.2)}.admonition.faq>.admonition-title:before,.admonition.help>.admonition-title:before,.admonition.question>.admonition-title:before{color:#64dd17;content:"\E887"}.admonition.attention,.admonition.caution,.admonition.warning{border-left-color:rgba(255,145,0,.8)}.admonition.attention>.admonition-title,.admonition.caution>.admonition-title,.admonition.warning>.admonition-title{background-color:rgba(255,145,0,.1);border-bottom-color:rgba(255,145,0,.2)}.admonition.attention>.admonition-title:before{color:#ff9100;content:"\E417"}.admonition.caution>.admonition-title:before,.admonition.warning>.admonition-title:before{color:#ff9100;content:"\E002"}.admonition.fail,.admonition.failure,.admonition.missing{border-left-color:rgba(255,82,82,.8)}.admonition.fail>.admonition-title,.admonition.failure>.admonition-title,.admonition.missing>.admonition-title{background-color:rgba(255,82,82,.1);border-bottom-color:rgba(255,82,82,.2)}.admonition.fail>.admonition-title:before,.admonition.failure>.admonition-title:before,.admonition.missing>.admonition-title:before{color:#ff5252;content:"\E14C"}.admonition.bug,.admonition.danger,.admonition.error{border-left-color:rgba(255,23,68,.8)}.admonition.bug>.admonition-title,.admonition.danger>.admonition-title,.admonition.error>.admonition-title{background-color:rgba(255,23,68,.1);border-bottom-color:rgba(255,23,68,.2)}.admonition.danger>.admonition-title:before{color:#ff1744;content:"\E3E7"}.admonition.error>.admonition-title:before{color:#ff1744;content:"\E14C"}.admonition.bug>.admonition-title:before{color:#ff1744;content:"\E868"}.admonition.example,.admonition.snippet{border-left-color:rgba(0,184,212,.8)}.admonition.example>.admonition-title,.admonition.snippet>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.example>.admonition-title:before,.admonition.snippet>.admonition-title:before{color:#00b8d4;content:"\E242"}.admonition.cite,.admonition.quote{border-left-color:rgba(158,158,158,.8)}.admonition.cite>.admonition-title,.admonition.quote>.admonition-title{background-color:rgba(158,158,158,.1);border-bottom-color:rgba(158,158,158,.2)}.admonition.cite>.admonition-title:before,.admonition.quote>.admonition-title:before{color:#9e9e9e;content:"\E244"}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="大模型工程化建设概览">大模型工程化建设概览 </h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><img src="./imges/image.png" alt="image.png" width="30px" height="25px"> <em>当大家都去挖金矿时，卖铲子的最赚钱</em></p>
</div>
<h2 id="大模型发展">大模型发展 </h2>
<p>大模型即「大规模预训练模型」，其研究聚焦于两个核心命题：<strong>模型训练</strong>与<strong>推理优化</strong>；</p>
<p><strong>训练</strong>：通过优化模型参数，使损失函数最小化，以提升推理结果的准确性；</p>
<blockquote>
<p>关键转折点：2020年后，大模型借助无需标注的文本数据和GPU算力，实现参数规模与性能的指数级提升</p>
</blockquote>
<p><strong>推理</strong>：基于预训练模型的固定参数（模型），对新输入数据进行预测或生成输出；</p>
<blockquote>
<p>随着技术成熟，AI基础设施（AI&nbsp;Infra）成为行业关注焦点</p>
</blockquote>
<h2 id="工程实践">工程实践 </h2>
<p>在没有“铲子”的情况下，如何使用大模型技术来构建自己的应用；</p>
<p><img src="./imges/llm.png" alt="image.png"></p>
<blockquote>
<p><a href="https://antoss-landscape.my.canva.site/">https://antoss-landscape.my.canva.site/</a></p>
</blockquote>
<h3 id="transformer回顾">Transformer回顾 </h3>
<p>回顾transformer中的核心公式：</p>
<ol>
<li>
<p><strong>自注意力机制（Self-Attention）</strong></p>
<p><img src="./imges/image_1.png" alt="image.png"></p>
<p><img src="./imges/image_17.png" alt="image.png"></p>
<p><img src="./imges/image_16.png" alt="image.png"></p>
</li>
<li>
<p><strong>前馈网络（FFN）</strong></p>
<p><img src="./imges/image_15.png" alt="image.png"></p>
</li>
<li>
<p><strong>残差连接（Residual&nbsp;Connection）</strong></p>
</li>
</ol>
<p>通过跳跃连接缓解梯度消失问题：</p>
<p><img src="./imges/image_14.png" alt="image.png"><br>
<img src="./imges/image_13.png" alt="image.png"></p>
<h3 id="基础设施建设ai-infra">基础设施建设（AI&nbsp;Infra） </h3>
<h4 id="模型训练">模型训练 </h4>
<p>模型训练主要分为两个阶段：<strong>预训练阶段</strong>和<strong>微调阶段</strong>；</p>
<p><strong>预训练阶段</strong>：在大规模的无标签数据集上接受训练，目标是使模型掌握语言的统计特征和基础知识。预训练实质上是一种无监督学习过程，完成预训练的模型被称为<strong>基座模型（Base&nbsp;Model）</strong>；</p>
<p><strong>微调阶段</strong>：在部分情况下基础模型提供的泛化能力并不满足特定垂直领域在专业知识、性能等方面的诉求，会在针对性的任务数据集上接受更进一步的训练，这一阶段主要涉及对<strong>模型权重的细微调整</strong>；</p>
<p><img src="./imges/image_12.png" alt="image.png"></p>
<h5 id="模型微调fine-tuning">模型微调（Fine-Tuning） </h5>
<p>常见的微调类型包括：</p>
<p><strong>Prefix-Tuning/P-Tuning/Prompt-Tuning</strong>：通过可学习前缀或连续提示调整注意力机制，会减少最大序列长度；</p>
<p><strong>Adapter-Tuning</strong>：在模型层间插入适配器模块（小型神经网络），会引入推理延迟；</p>
<p><strong>LoRA（Low-Rank&nbsp;Adaptation）</strong>：低秩矩阵分解，参数量仅0.1%-1%；通过向<strong>模型权重矩阵</strong>添加低秩矩阵来进行微调，<strong>既允许模型学习新的任务特定模式，又能够保留大部分预训练知识</strong>，从而降低过拟合风险并提高训练效率；</p>
<p><img src="./imges/image_11.png" alt="image.png"></p>
<h5 id="loraqlora">LoRA/QLoRA </h5>
<p><strong>基本概念</strong></p>
<p><strong>（向量）线性无关</strong>：一组向量&nbsp;线性无关，当且仅当&nbsp;<strong>没有任何一个向量能通过其他向量的线性组合</strong>&nbsp;表示出来，即：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mn>1</mn></msub><msub><mi>v</mi><mn>1</mn></msub><mo>+</mo><msub><mi>c</mi><mn>2</mn></msub><msub><mi>v</mi><mn>2</mn></msub><mo>+</mo><mo separator="true">⋅</mo><mo separator="true">⋅</mo><mo separator="true">⋅</mo><mo>+</mo><msub><mi>c</mi><mi>n</mi></msub><msub><mi>v</mi><mi>n</mi></msub><mtext>&nbsp;</mtext><mo>=</mo><mtext>&nbsp;</mtext><mn>0</mn></mrow><annotation encoding="application/x-tex">c_1v_1+c_2v_2+···+c_nv_n&nbsp;=&nbsp;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">+</span><span class="mpunct">⋅⋅⋅</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">+</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">&nbsp;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">&nbsp;0</span></span></span></span>，当且仅当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c_i=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>时成立；</p>
<p><strong>矩阵的秩</strong>：其行（或列）向量组的极大线性无关组的个数</p>
<ul>
<li>
<p>**满秩矩阵（Full-Rank）****：**一个矩阵的秩&nbsp;=&nbsp;其行/列数中的较小值</p>
<ul>
<li>Q,K,V线性变换矩阵或前馈网络的全连接层通常是满秩的，因为它们需要捕捉数据中的复杂特征且尽量减少冗余；</li>
</ul>
</li>
<li>
<p><strong>低秩矩阵（Low-Rank）</strong>：一个矩阵的秩&nbsp;&lt;&nbsp;其行/列数中的较小值;</p>
</li>
</ul>
<blockquote>
<p>直观理解：</p>
</blockquote>
<blockquote>
<p>满秩：每个向量都提供了“独一无二”的信息，无法被其他向量替代；</p>
</blockquote>
<blockquote>
<p>低秩：至少有一个向量可以被其他向量“替代”，存在冗余；</p>
</blockquote>
<p><strong>LoRA（低秩适配器）</strong></p>
<blockquote>
<p><a href="https://arxiv.org/abs/2106.09685">LoRA:&nbsp;Low-Rank&nbsp;Adaptation&nbsp;of&nbsp;Large&nbsp;Language&nbsp;Models</a></p>
</blockquote>
<p>主要思想是冻结预训练模型的权重，并在每个&nbsp;Transformer&nbsp;块中添加一个可训练的层，即旁路矩阵&nbsp;A&nbsp;和&nbsp;B；</p>
<p><strong>低秩分解</strong>：其核心思想是将一个高维矩阵&nbsp;<strong>近似表示为两个或多个低秩矩阵的乘积</strong>，从而在保持大部分信息的前提下，<strong>显著降低参数规模和前向传播的计算复杂度</strong>；</p>
<blockquote>
<p><strong>理论支撑：大模型训练中****即使在随机投影到较小子空间后，仍然可以高效学习；</strong><a href="https://arxiv.org/abs/2012.13255">Intrinsic&nbsp;Dimensionality&nbsp;Explains&nbsp;the&nbsp;Effectiveness&nbsp;of&nbsp;Language&nbsp;Model&nbsp;Fine-Tuning</a><img src="./imges/image_10.png" alt="image.png"></p>
</blockquote>
<p><img src="./imges/image_9.png" alt="image.png"></p>
<p>假设预训练权重矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>∗</mo><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W_0\in\Reals^{d*k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">∗</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span>，而微调过程就是要寻找<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mtext>&nbsp;</mtext><mo>+</mo><mtext>&nbsp;</mtext><mo>△</mo><mtext>&nbsp;</mtext><mi>W</mi></mrow><annotation encoding="application/x-tex">W=W_0&nbsp;+&nbsp;\vartriangle&nbsp;W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">&nbsp;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5499em;"></span><span class="mord">&nbsp;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel amsrm">△</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>△</mo><mtext>&nbsp;</mtext><mi>W</mi></mrow><annotation encoding="application/x-tex">\vartriangle&nbsp;W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5499em;"></span><span class="mrel amsrm">△</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>，通过低秩分解可得到如下公式：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mtext>&nbsp;</mtext><mo>+</mo><mtext>&nbsp;</mtext><mi>B</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">W=W_0&nbsp;+&nbsp;BA</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">&nbsp;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span></span></span></span>，其中&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>∗</mo><mi>r</mi></mrow></msup></mrow><annotation encoding="application/x-tex">B\in\Reals^{d*r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">∗</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>r</mi><mo>∗</mo><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">A\in\Reals^{r*k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">∗</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>≪</mo><mtext>&nbsp;</mtext><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>d</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r\ll&nbsp;min(d,k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal">min</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>为低秩矩阵的秩；</p>
<ul>
<li>
<p><strong>参数规模：</strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>∗</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">d*k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>&nbsp;<strong>--&gt;</strong>&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>∗</mo><mo stretchy="false">(</mo><mi>d</mi><mo>+</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r*(d+k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4653em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></p>
</li>
<li>
<p><strong>计算复杂度：</strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>△</mo><mtext>&nbsp;</mtext><mi>W</mi><mtext>&nbsp;</mtext><mo>∗</mo><mtext>&nbsp;</mtext><mi>x</mi></mrow><annotation encoding="application/x-tex">\vartriangle&nbsp;W&nbsp;*&nbsp;x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5499em;"></span><span class="mrel amsrm">△</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord">&nbsp;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal">x</span></span></span></span>&nbsp;<strong>--&gt;</strong>&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>A</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">BAx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mord mathnormal">x</span></span></span></span><strong>=</strong>&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>d</mi><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(dk)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>&nbsp;<strong>--&gt;</strong>&nbsp;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>d</mi><mo>∗</mo><mi>r</mi><mo>+</mo><mi>r</mi><mo>∗</mo><mi>k</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(d*r+r*k))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4653em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">))</span></span></span></span></p>
</li>
</ul>
<p>在训练过程中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>被冻结，不接受梯度更新，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>包含可训练参数，<strong>在</strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span><strong>足够小的时候可以显著降低训练的计算复杂度</strong>；</p>
<p><strong>训练过程</strong></p>
<p><img src="./imges/image_8.png" alt="image.png"></p>
<blockquote>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/702629428">https://zhuanlan.zhihu.com/p/702629428</a></p>
</blockquote>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∂</mi><mtext>&nbsp;</mtext><mi>L</mi></mrow><annotation encoding="application/x-tex">\partial&nbsp;L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord">&nbsp;</span><span class="mord mathnormal">L</span></span></span></span>表示损失函数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∂</mi><mtext>&nbsp;</mtext><mi>x</mi></mrow><annotation encoding="application/x-tex">\partial&nbsp;x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord">&nbsp;</span><span class="mord mathnormal">x</span></span></span></span>表示输入，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∂</mi><mtext>&nbsp;</mtext><mi>h</mi></mrow><annotation encoding="application/x-tex">\partial&nbsp;h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord">&nbsp;</span><span class="mord mathnormal">h</span></span></span></span>表示输出，通过反向传播公式变换得出：</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>h</mi></mrow></mfrac><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>h</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>h</mi></mrow></mfrac><mo stretchy="false">(</mo><msub><mi>W</mi><mn>0</mn></msub><mo>+</mo><mi>B</mi><mi>A</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac {\partial L}  {\partial x} =  \frac {\partial L}  {\partial h} \frac {\partial h}  {\partial x} = \frac {\partial L}  {\partial h}(W_0 + BA)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">h</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">x</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">h</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span></span>，输入<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∂</mi><mtext>&nbsp;</mtext><mi>x</mi></mrow><annotation encoding="application/x-tex">\partial&nbsp;x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord">&nbsp;</span><span class="mord mathnormal">x</span></span></span></span>和输出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∂</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">\partial h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">h</span></span></span></span>基于训练数据是已知的，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">W_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为预训练的权重矩阵固定不变，则可以根据预设的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∂</mi><mtext>&nbsp;</mtext><mi>L</mi></mrow><annotation encoding="application/x-tex">\partial&nbsp;L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord">&nbsp;</span><span class="mord mathnormal">L</span></span></span></span>反推出微调参数矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>；</p>
<p><strong>反向传播</strong>：从损失函数出发，利用链式法则逐层计算梯度，更新模型参数；</p>
<p><strong>训练结果</strong></p>
<p>得到低秩矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>，并保存为单独的层，可按需加载；</p>
<p><strong>QLoRA（量化LoRA）</strong></p>
<blockquote>
<p><a href="https://arxiv.org/abs/2305.14314">QLoRA:&nbsp;Efficient&nbsp;Finetuning&nbsp;of&nbsp;Quantized&nbsp;LLMs</a></p>
</blockquote>
<p>牺牲参数的精度来降低显存消耗，提升训练效率，在推理部分重点介绍；</p>
<h5 id="工程实现">工程实现 </h5>
<div class="admonition note">
<p class="admonition-title">参考</p>
<p><em>以下参考的是：</em><a href="https://llamafactory.readthedocs.io/zh-cn/latest/#">LLaMA-Factory</a></p>
</div>
<p>LLaMA-Factory：一个简单易用且高效的大型语言模型（Large&nbsp;Language&nbsp;Model）训练与微调平台，可通过简单的参数配置进行模型微调；</p>
<pre data-role="codeBlock" data-info="shell" class="language-shell shell"><code><span class="token builtin class-name">.</span>
├── data           -- 训练数据集
├── evaluation
├── examples       -- 参考示例
├── pyproject.toml
├── requirements.txt
├── scripts
├── setup.py       -- 安装脚本
├── src            -- 源代码
</code></pre><p>常用的3个命令：</p>
<div class="admonition note">
<p class="admonition-title">微调</p>
<p>llamafactory-cli&nbsp;train&nbsp;examples/train_lora/llama3_lora_sft.yaml&nbsp;&nbsp;&nbsp;--&nbsp;微调</p>
<p>llamafactory-cli&nbsp;chat&nbsp;examples/inference/llama3_lora_sft.yaml&nbsp;&nbsp;&nbsp;--&nbsp;对话</p>
<p>llamafactory-cli&nbsp;export&nbsp;examples/merge_lora/llama3_lora_sft.yaml&nbsp;&nbsp;&nbsp;--&nbsp;LoRA微调合并（非必需）</p>
</div>
<blockquote>
<p><a href="https://modelscope.cn/docs/notebooks/intro">ModelScope</a>平台限时免费的资源，可以体验模型训练的过程</p>
</blockquote>
<h4 id="模型推理llm-inference">模型推理（LLM&nbsp;Inference） </h4>
<p>大模型本质上只是训练好的参数、数据，需要借助硬件支持、推理引擎的能力提供服务；</p>
<div class="admonition note">
<p class="admonition-title">参考</p>
<p><em>以下参考的是：</em><a href="https://arxiv.org/abs/2404.14294">A&nbsp;Survey&nbsp;on&nbsp;Efficient&nbsp;Inference&nbsp;for&nbsp;Large&nbsp;Language&nbsp;Models</a></p>
</div>
<p>传统&nbsp;Transformer&nbsp;模型是建立在编码器-解码器架构上，由两个&nbsp;Transformer&nbsp;块分别作为编码器和解码器，常见架构：</p>
<ul>
<li>
<p><strong>Encoder-Only</strong>：BERT、ViT（图像分类）</p>
</li>
<li>
<p><strong>Decoder-Only</strong>：GPT系列、LLaMA</p>
</li>
<li>
<p><strong>Encoder-Decoder</strong>：原始Transformer（翻译）、T5、BART</p>
</li>
</ul>
<p>目前主流的模型（如GPT、LLaMA、Qwen）都是基于<strong>Decoder-Only</strong>架构实现的，在训练效率和工程实现都有较大的优势；</p>
<h5 id="decoder-only推理引擎">Decoder-Only推理引擎 </h5>
<p><img src="./imges/image_18.png" alt="image.png"></p>
<p>目前市面上的开源、自研类的推理引擎有很多，主要的流程分为两个阶段：</p>
<p><strong>预填充（Prefilling）阶段</strong>：</p>
<ol>
<li>
<p><strong>分词（Tokenizer）</strong></p>
<p>将用户输入文本通过分词器（tokenizer）转换为数字token序列，</p>
<p><code>输入："你好"&nbsp;-&gt;&nbsp;[2345,&nbsp;6789]</code></p>
</li>
<li>
<p><strong>词嵌入（Embedding）</strong></p>
<p>将token转换为高维向量（张量），并叠加位置编码，形成模型可处理的输入；</p>
</li>
<li>
<p><em><strong>初始KV缓存（First&nbsp;Token）</strong></em></p>
<p><em>计算并存储初始输入的KV缓存，生成首个输出token</em>_；（基于KV&nbsp;Cache机制定义）_</p>
<p><strong>解码（Decoding）阶段</strong>：</p>
</li>
<li>
<p><strong>自回归过程（Decode）</strong></p>
<p>Transformer解码器自回归执行过程，LLM生成的核心过程，经过自注意力、FNN等流程，具体参考Transformer基本原理；</p>
</li>
<li>
<p><strong>采样策略（Sampling）</strong></p>
</li>
</ol>
<p>基于概率分布选择token，支持：</p>
<ul>
<li>
<p>Top-k采样：仅保留概率最高的k个token</p>
</li>
<li>
<p>Top-p（核采样）：保留累积概率达p的token</p>
</li>
<li>
<p>Temperature调节：控制输出的随机性（temperature=1为默认）</p>
</li>
</ul>
<ol>
<li><strong>结果生成（Output）</strong></li>
</ol>
<p>将token序列转换回文本，追加至输出结果；</p>
<p><img src="./imges/image_28.png" alt="image.png"></p>
<blockquote>
<p>推理引擎各阶段开销，参考：<a href="https://arxiv.org/pdf/2404.14294">https://arxiv.org/pdf/2404.14294</a></p>
</blockquote>
<h5 id="推理优化">推理优化 </h5>
<p>推理优化技术是大模型落地应用的关键，涉及的知识面很广，相关技术论文整合：<a href="https://github.com/xlite-dev/Awesome-LLM-Inference?tab=readme-ov-file#awesome-llm-inference-papers-with-codes">Awesome-LLM-Inference</a></p>
<h6 id="kv-cache">KV-Cache </h6>
<p>用于缓存自注意力机制的中间结果（K和V矩阵）的优化技术，主要用于生成式模型推理阶段；是一种以空间换时间、动态规划的思路的优化策略；</p>
<ul>
<li>
<p>传统方式：每次计算时需重新计算所有历史K和V，时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>；</p>
</li>
<li>
<p>KV-Cache优化：</p>
<ul>
<li>
<p><strong>缓存K和V</strong>：仅存储历史注意力计算结果，空间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>；</p>
</li>
<li>
<p><strong>增量计算</strong>：新token仅需与当前K、V进行交互，时间复杂度降为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>；</p>
</li>
</ul>
</li>
</ul>
<p><strong>数学解释</strong></p>
<p>回到自注意力计算公式：</p>
<p><img src="./imges/image_27.png" alt="image.png"></p>
<p><img src="./imges/image_26.png" alt="image.png">，</p>
<p>我们暂且先忽略掉<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mpadded depth="0px"><msub><mi>d</mi><mi>k</mi></msub></mpadded></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{\smash[b]{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1078em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span></span></span></span></span></span></span></span></span>的影响，可以有以下的矩阵计算过程：</p>
<p><img src="./imges/image_25.png" alt="image.png"></p>
<p><img src="./imges/image_24.png" alt="image.png"></p>
<p>在实际的推理过程中为了避免推理过程中看到未来的位置，还会设计一个**因果掩码（Causal&nbsp;Mask）**来加入计算，公式更改为：</p>
<p><img src="./imges/image_23.png" alt="image.png"></p>
<p>由此可见对于位置T，除了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mi mathvariant="normal">_</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">q\_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9933em;vertical-align:-0.31em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span>参与计算，K、V位置T及其之前的均要参与计算，<strong>所以无需缓存Q，却需要缓存K、V</strong>；</p>
<p><img src="./imges/image_22.png" alt="image.png"></p>
<p><strong>KV&nbsp;Cache&nbsp;的工作流程</strong></p>
<p>预填充（Prefilling）阶段：根据输入Tokens，逐一生成对应的K、V并缓存；</p>
<p>解码（Decoding）阶段：在自回归生成后续Token时，仅需计算当前token的K、V并缓存，并且复用已经缓存的K、V用于最新的注意力计算；</p>
<p><img src="./imges/image_21.png" alt="image.png"></p>
<blockquote>
<p>参考：<a href="https://www.cnblogs.com/rossiXYZ/p/18799503#23-%E9%87%8D%E6%96%B0%E5%AE%9A%E4%B9%89%E9%98%B6%E6%AE%B5">探秘Transformer系列之（20）---&nbsp;KV&nbsp;Cache</a></p>
</blockquote>
<p><strong>显存上的挑战</strong></p>
<p>以Qwen2.5-7B-Instruct模型为例，最大Token长度为32768，单次请求&nbsp;KV&nbsp;Cache消耗的最大显存：</p>
<p><img src="./imges/image_20.png" alt="image.png"></p>
<p>常见的优化手段，内存分片、压缩、碎片整理（<a href="https://arxiv.org/abs/2309.06180">PageAttention</a>）、量化等技术；</p>
<h6 id="量化">量化 </h6>
<blockquote>
<p>在本地化、边缘计算场景的部署方案中大多会用到量化的技术</p>
</blockquote>
<p><strong>原理</strong>：将模型权重从FP32（32位浮点）压缩到低精度（如FP16、INT8、INT4甚至二值化），平衡精度与效率；（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>∗</mo><mi>x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">W*x+b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>，将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>参数转换成半精度（BF）、整数表示）；</p>
<p><strong>效果</strong>：减少内存占用（如INT8可压缩4倍），加速计算（尤其在支持低精度的硬件上）。</p>
<p><strong>量化的对象：权重、KV&nbsp;Cache等</strong></p>
<p><strong>基础原理</strong></p>
<p>根据每个tensor的浮点型最大值和最小值，将其映射为一个固定范围的整形数值集合，比如[-127~127]；</p>
<p><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub><mo>=</mo><mi>r</mi><mi>o</mi><mi>u</mi><mi>n</mi><mi>d</mi><mo stretchy="false">(</mo><mi>W</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mtext>&nbsp;</mtext><mo>+</mo><mtext>&nbsp;</mtext><mi>z</mi><mi>e</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">W_q=round(W/scale&nbsp;+&nbsp;zeropoint)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ro</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord">/</span><span class="mord mathnormal">sc</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord">&nbsp;</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">&nbsp;</span><span class="mord mathnormal">zero</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></strong></p>
<p>其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>代表量化后权重，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>代表量化前权重</p>
<ul>
<li>
<p>scale代表缩放因子，表示浮点数与整数的缩放比例；</p>
</li>
<li>
<p>zeropoint表示零点，用于非对称量化时的偏移补偿；</p>
</li>
</ul>
<p><img src="./imges/image_19.png" alt="image.png"></p>
<p>//&nbsp;TODO&nbsp;量化处理过程</p>
<p>bitsandbytes：<a href="https://arxiv.org/pdf/2110.02861">https://arxiv.org/pdf/2110.02861</a>、<a href="https://github.com/bitsandbytes-foundation/bitsandbytes">项目地址</a></p>
<h5 id="模型部署">模型部署 </h5>
<div class="admonition note">
<p class="admonition-title">参考</p>
<p><em>参考的是本地化部署工具</em><a href="https://github.com/ollama/ollama">Ollama</a>，类似的框架还有<a href="https://github.com/vllm-project/vllm">vllm</a></p>
</div>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="800px" preserveAspectRatio="none" style="width:919px;height:800px;background:#FFFFFF;" version="1.1" viewBox="0 0 919 800" width="919px" zoomAndPan="magnify"><defs></defs><g><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="403.9512" x="290.5938" y="196.7305"></rect><rect fill="none" height="403.0371" style="stroke:#000000;stroke-width:1.5;" width="540.4819" x="280.5938" y="286.6621"></rect><rect fill="none" height="59.6211" style="stroke:#000000;stroke-width:1.5;" width="193.1934" x="594.6943" y="340.2832"></rect><rect fill="none" height="59.6211" style="stroke:#000000;stroke-width:1.5;" width="216.3813" x="594.6943" y="413.9043"></rect><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="403.9512" x="290.5938" y="516.8359"></rect><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="403.9512" x="290.5938" y="606.7676"></rect><g><title>ollama_server</title><rect fill="#000000" fill-opacity="0.00000" height="728.832" width="8" x="117.8174" y="36.4883"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="120.9844" x2="120.9844" y1="36.4883" y2="765.3203"></line></g><g><title>llama_server</title><rect fill="#000000" fill-opacity="0.00000" height="728.832" width="8" x="346.127" y="36.4883"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="349.5938" x2="349.5938" y1="36.4883" y2="765.3203"></line></g><g><title>llama.cpp</title><rect fill="#000000" fill-opacity="0.00000" height="728.832" width="8" x="640.6196" y="36.4883"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="643.6943" x2="643.6943" y1="36.4883" y2="765.3203"></line></g><g class="participant participant-head" data-participant="ollama_server"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="107.666" x="67.9844" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93.666" x="74.9844" y="25.5352">ollama_server</text></g><g class="participant participant-tail" data-participant="ollama_server"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="107.666" x="67.9844" y="764.3203"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93.666" x="74.9844" y="784.8555">ollama_server</text></g><g class="participant participant-head" data-participant="llama_server"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99.0664" x="300.5938" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85.0664" x="307.5938" y="25.5352">llama_server</text></g><g class="participant participant-tail" data-participant="llama_server"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99.0664" x="300.5938" y="764.3203"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85.0664" x="307.5938" y="784.8555">llama_server</text></g><g class="participant participant-head" data-participant="llama.cpp"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="79.8506" x="604.6943" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65.8506" x="611.6943" y="25.5352">llama.cpp</text></g><g class="participant participant-tail" data-participant="llama.cpp"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="79.8506" x="604.6943" y="764.3203"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65.8506" x="611.6943" y="784.8555">llama.cpp</text></g><g class="message" data-participant-1="ollama_server" data-participant-2="ollama_server"><polygon fill="#181818" points="109.8174,63.7988,119.8174,67.7988,109.8174,71.7988,113.8174,67.7988" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="0" x2="115.8174" y1="67.7988" y2="67.7988"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59.522" x="7" y="63.0566">/api/chat</text></g><g class="message" data-participant-1="ollama_server" data-participant-2="ollama_server"><line style="stroke:#181818;stroke-width:1;" x1="121.8174" x2="163.8174" y1="97.1094" y2="97.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="163.8174" x2="163.8174" y1="97.1094" y2="110.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="122.8174" x2="163.8174" y1="110.1094" y2="110.1094"></line><polygon fill="#181818" points="132.8174,106.1094,122.8174,110.1094,132.8174,114.1094,128.8174,110.1094" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214.3096" x="128.8174" y="92.3672">模型兼容性检查[completion、tools]</text></g><g class="message" data-participant-1="ollama_server" data-participant-2="ollama_server"><line style="stroke:#181818;stroke-width:1;" x1="121.8174" x2="163.8174" y1="139.4199" y2="139.4199"></line><line style="stroke:#181818;stroke-width:1;" x1="163.8174" x2="163.8174" y1="139.4199" y2="152.4199"></line><line style="stroke:#181818;stroke-width:1;" x1="122.8174" x2="163.8174" y1="152.4199" y2="152.4199"></line><polygon fill="#181818" points="132.8174,148.4199,122.8174,152.4199,132.8174,156.4199,128.8174,152.4199" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85.668" x="128.8174" y="134.6777">prompt预处理</text></g><g class="message" data-participant-1="ollama_server" data-participant-2="llama_server"><polygon fill="#181818" points="338.127,177.7305,348.127,181.7305,338.127,185.7305,342.127,181.7305" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="121.8174" x2="344.127" y1="181.7305" y2="181.7305"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77.4541" x="128.8174" y="176.9883">/completion</text></g><path d="M290.5938,196.7305 L396.7725,196.7305 L396.7725,204.041 L386.7725,214.041 L290.5938,214.041 L290.5938,196.7305" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="403.9512" x="290.5938" y="196.7305"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61.1787" x="305.5938" y="210.2988">Tokenize</text><g class="message" data-participant-1="llama_server" data-participant-2="llama.cpp"><polygon fill="#181818" points="632.6196,231.3516,642.6196,235.3516,632.6196,239.3516,636.6196,235.3516" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="350.127" x2="638.6196" y1="235.3516" y2="235.3516"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240.9063" x="357.127" y="230.6094">C.llama_tokenize(vocab,text,tokens...)</text></g><g class="message" data-participant-1="llama.cpp" data-participant-2="llama_server"><polygon fill="#181818" points="361.127,260.6621,351.127,264.6621,361.127,268.6621,357.127,264.6621" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="355.127" x2="643.6196" y1="264.6621" y2="264.6621"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128.9526" x="367.127" y="259.9199">tokens(Token化结果)</text></g><path d="M280.5938,286.6621 L414.2134,286.6621 L414.2134,293.9727 L404.2134,303.9727 L280.5938,303.9727 L280.5938,286.6621" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="403.0371" style="stroke:#000000;stroke-width:1.5;" width="540.4819" x="280.5938" y="286.6621"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="88.6196" x="295.5938" y="300.2305">processBatch</text><path d="M826.0757,291.6621 L826.0757,316.6621 L912.0757,316.6621 L912.0757,301.6621 L902.0757,291.6621 L826.0757,291.6621" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"></path><path d="M902.0757,291.6621 L902.0757,301.6621 L912.0757,301.6621 L902.0757,291.6621" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"></path><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="832.0757" y="309.2305">异步批处理</text><g class="message" data-participant-1="llama_server" data-participant-2="llama.cpp"><polygon fill="#181818" points="632.6196,321.2832,642.6196,325.2832,632.6196,329.2832,636.6196,325.2832" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="350.127" x2="638.6196" y1="325.2832" y2="325.2832"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127.061" x="357.127" y="320.541">C.llama_decode(ctx)</text></g><path d="M594.6943,340.2832 L691.6943,340.2832 L691.6943,347.5938 L681.6943,357.5938 L594.6943,357.5938 L594.6943,340.2832" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="59.6211" style="stroke:#000000;stroke-width:1.5;" width="193.1934" x="594.6943" y="340.2832"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="52" x="609.6943" y="353.8516">张量计算</text><g class="message" data-participant-1="llama.cpp" data-participant-2="llama.cpp"><line style="stroke:#181818;stroke-width:1;" x1="644.6196" x2="686.6196" y1="378.9043" y2="378.9043"></line><line style="stroke:#181818;stroke-width:1;" x1="686.6196" x2="686.6196" y1="378.9043" y2="391.9043"></line><line style="stroke:#181818;stroke-width:1;" x1="645.6196" x2="686.6196" y1="391.9043" y2="391.9043"></line><polygon fill="#181818" points="655.6196,387.9043,645.6196,391.9043,655.6196,395.9043,651.6196,391.9043" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.2681" x="651.6196" y="374.1621">llama_build_graph()</text></g><path d="M594.6943,413.9043 L665.6943,413.9043 L665.6943,421.2148 L655.6943,431.2148 L594.6943,431.2148 L594.6943,413.9043" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="59.6211" style="stroke:#000000;stroke-width:1.5;" width="216.3813" x="594.6943" y="413.9043"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="26" x="609.6943" y="427.4727">推理</text><g class="message" data-participant-1="llama.cpp" data-participant-2="llama.cpp"><line style="stroke:#181818;stroke-width:1;" x1="644.6196" x2="686.6196" y1="452.5254" y2="452.5254"></line><line style="stroke:#181818;stroke-width:1;" x1="686.6196" x2="686.6196" y1="452.5254" y2="465.5254"></line><line style="stroke:#181818;stroke-width:1;" x1="645.6196" x2="686.6196" y1="465.5254" y2="465.5254"></line><polygon fill="#181818" points="655.6196,461.5254,645.6196,465.5254,655.6196,469.5254,651.6196,465.5254" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147.4561" x="651.6196" y="447.7832">llama_graph_compute()</text></g><g class="message" data-participant-1="llama.cpp" data-participant-2="llama_server"><polygon fill="#181818" points="361.127,497.8359,351.127,501.8359,361.127,505.8359,357.127,501.8359" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="355.127" x2="643.6196" y1="501.8359" y2="501.8359"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123.8872" x="367.127" y="497.0938">tokens(Decode结果)</text></g><path d="M290.5938,516.8359 L432.2876,516.8359 L432.2876,524.1465 L422.2876,534.1465 L290.5938,534.1465 L290.5938,516.8359" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="403.9512" x="290.5938" y="516.8359"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="96.6938" x="305.5938" y="530.4043">后处理(sample)</text><g class="message" data-participant-1="llama_server" data-participant-2="llama.cpp"><polygon fill="#181818" points="632.6196,551.457,642.6196,555.457,632.6196,559.457,636.6196,555.457" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="350.127" x2="638.6196" y1="555.457" y2="555.457"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270.4927" x="357.127" y="550.7148">C.common_sampler_csample(tokens,k,p...)</text></g><g class="message" data-participant-1="llama.cpp" data-participant-2="llama_server"><polygon fill="#181818" points="361.127,580.7676,351.127,584.7676,361.127,588.7676,357.127,584.7676" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="355.127" x2="643.6196" y1="584.7676" y2="584.7676"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35.7563" x="367.127" y="580.0254">token</text></g><path d="M290.5938,606.7676 L361.5938,606.7676 L361.5938,614.0781 L351.5938,624.0781 L290.5938,624.0781 L290.5938,606.7676" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:1.5;" width="403.9512" x="290.5938" y="606.7676"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="26" x="305.5938" y="620.3359">解码</text><g class="message" data-participant-1="llama_server" data-participant-2="llama.cpp"><polygon fill="#181818" points="632.6196,641.3887,642.6196,645.3887,632.6196,649.3887,636.6196,645.3887" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="350.127" x2="638.6196" y1="645.3887" y2="645.3887"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192.5181" x="357.127" y="640.6465">C.llama_token_to_piece(token)</text></g><g class="message" data-participant-1="llama.cpp" data-participant-2="llama_server"><polygon fill="#181818" points="361.127,670.6992,351.127,674.6992,361.127,678.6992,357.127,674.6992" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="355.127" x2="643.6196" y1="674.6992" y2="674.6992"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="367.127" y="669.957">文本</text></g><g class="message" data-participant-1="llama_server" data-participant-2="ollama_server"><polygon fill="#181818" points="132.8174,714.0098,122.8174,718.0098,132.8174,722.0098,128.8174,718.0098" style="stroke:#181818;stroke-width:1;"></polygon><ellipse cx="349.627" cy="717.2598" fill="#000000" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"></ellipse><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="126.8174" x2="345.127" y1="718.0098" y2="718.0098"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="138.8174" y="713.2676">流式返回</text></g><g class="message" data-participant-1="ollama_server" data-participant-2="ollama_server"><polygon fill="#181818" points="11,743.3203,1,747.3203,11,751.3203,7,747.3203" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="5" x2="120.8174" y1="747.3203" y2="747.3203"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.8174" x="17" y="742.5781">流式/非流式返回</text></g><!--SRC=[ZLDFJy8m7BttK_Iu9MpSYU6WVWHln2obL5WOQxCLGZo1GOdHe8b63oAAIE2Wt3mGIVmmPWM-XVl3b24PN9gcl_T-xxt-MeOihcET8PD3QXYeX3IRM1LY0RPKYI-ec340G4PHb7IaHmec4TEJk80u094ALD9m1Ig6NQTpuPnEdD5Or0QYLnDF_Goc9MOGhbFpkrRdb1hsuUPMp79PVFxIS5uRq-kpDOGLbtyg482yHSiC7j0YCVLZ0jPIlSWfkAS6HRx0IXMAKJR1IPKd_3DRLLKP_3AWyaywW4c-cdDvD_sy4Pss38YP2usuOJ2nxLt4SG5kuoP7CCqH2VEg7FPm9i_pvjLir9sExfVjHFW1ErlMZPoMjn0hI14VeZNqxZAUxVCqxphBd8JyBVBl-vx3zA7hwrOmGCb6tdpacFHxgYjQegOMG2qD1nif44WK4yoVnMOpovbdWzxqkHuhk_G2t5LZEi4BqVZ1YxkcQBy5OjvYKawWGOvuoftMYNZlY_Dn-7mZ-bHPytS-wixaQlPrwpnq0DXHbFM0vFon4u7-0000]--></g></svg></p><p>Ollama采用分层设计，借鉴Docker的交互理念，分为两层：</p>
<ol>
<li>
<p><strong>用户层（Ollama&nbsp;Server）</strong>：面向用户，提供简洁易用的接口封装，降低使用门槛。</p>
</li>
<li>
<p><strong>推理层（llama&nbsp;Server）</strong>：通过cgo调用C++实现的<strong>llama.cpp</strong>推理引擎，结合GGML库的量化技术优化模型推理，减少内存占用并提升速度（支持本地化部署）。</p>
</li>
</ol>
<p><a href="https://huggingface.co/blog/introduction-to-ggml">GGML</a>：C语言开发的张量库，支持模型量化，实现轻量化推理；<a href="https://github.com/Yangxiaoz/GGML-Tutorial/blob/main/doc/Core-Concepts.md">参考2</a>、<a href="https://zgh551.github.io/2025/02/15/llama-cpp-ggml/">参考3</a></p>
<p><a href="https://github.com/ggml-org/ggml/blob/master/docs/gguf.md">GGUF</a>：模型存储格式，用于高效保存和加载适配GGML推理的模型数据。<a href="https://zgh551.github.io/2025/02/15/llama-cpp-ggml/">参考1</a></p>
<p>支持的量化方式：<a href="https://zhuanlan.zhihu.com/p/12729759086">https://zhuanlan.zhihu.com/p/12729759086</a></p>
<h3 id="平台化paas">平台化（Paas） </h3>
<p>模型训练和推理优化属于大模型基础设置（AI&nbsp;Infra）的范畴，在Paas主要的命题是如何将大模型的推理能力提供用户，支持用户快速构建应用；常见的两种范式（系统）是Agent、Workflow；</p>
<h4 id="agent">Agent </h4>
<p><img src="./imges/image_7.png" alt="image.png"></p>
<blockquote>
<p><a href="https://lilianweng.github.io/posts/2023-06-23-agent/">https://lilianweng.github.io/posts/2023-06-23-agent/</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
<th>落地场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>上下文记忆（Memory）</td>
<td>负责上下文信息的管理和查询</td>
<td>多轮对话、RAG等</td>
</tr>
<tr>
<td>推理/规划（Reason/Planning）</td>
<td>负责推理、任务的拆解和规划</td>
<td>各种LLM（Agent的大脑）</td>
</tr>
<tr>
<td>动作/工具（Action/Tool）</td>
<td>负责LLM与外部环境沟通、交互</td>
<td>通过Function&nbsp;Calling技术调用</td>
</tr>
</tbody>
</table>
<h5 id="react-agent">React&nbsp;Agent </h5>
<p>适用于复杂问题求解、多步骤任务执行；<strong>边思考边行动</strong>（<a href="https://arxiv.org/abs/2210.03629">论文</a>）</p>
<p><img src="./imges/image_6.png" alt="image"></p>
<p>ReAct模式将推理阶段（reasoning）和动作阶段（action）进行有效的结合，是一个循环交互的过程：</p>
<ol>
<li>
<p>基于LLM强大的推理能力，决定后续执行的动作</p>
</li>
<li>
<p>动作执行完成，将结果通过上下文反馈给LLM</p>
</li>
</ol>
<p>根据用户初始设定的目标，循环以上步骤（一般有循环次数限制），直到得到最终的结果，返回给用户；</p>
<h5 id="工程实现-1">工程实现 </h5>
<div class="admonition note">
<p class="admonition-title">参考</p>
<p><em>参考的是</em><a href="https://github.com/tmc/langchaingo"><em>LangChainGo</em></a><em>开发框架</em>，类似的框架还有<a href="https://github.com/langgenius/dify">Dify</a>（Define&nbsp;+&nbsp;Modify）</p>
</div>
<p><strong>抽象模型</strong></p>
<p><img src="./imges/image_5.png" alt="image.png"></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// Model is an interface multi-modal models implement.</span>
<span class="token keyword keyword-type">type</span> Model <span class="token keyword keyword-interface">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// GenerateContent asks the model to generate content from a sequence of</span>
	<span class="token comment">// messages. It's the most general interface for multi-modal LLMs that support</span>
	<span class="token comment">// chat-like interactions.</span>
	<span class="token function">GenerateContent</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> messages <span class="token punctuation">[</span><span class="token punctuation">]</span>MessageContent<span class="token punctuation">,</span> options <span class="token operator">...</span>CallOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ContentResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Memory is the interface for memory in chains.</span>
<span class="token keyword keyword-type">type</span> Memory <span class="token keyword keyword-interface">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// GetMemoryKey getter for memory key.</span>
	<span class="token function">GetMemoryKey</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token comment">// MemoryVariables Input keys this memory class will load dynamically.</span>
	<span class="token function">MemoryVariables</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token comment">// LoadMemoryVariables Return key-value pairs given the text input to the chain.</span>
	<span class="token comment">// If None, return all memories</span>
	<span class="token function">LoadMemoryVariables</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> inputs <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// SaveContext Save the context of this model run to memory.</span>
	<span class="token function">SaveContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> inputs <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">,</span> outputs <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token comment">// Clear memory contents.</span>
	<span class="token function">Clear</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment">// Tool is a tool for the llm agent to interact with different applications.</span>
<span class="token keyword keyword-type">type</span> Tool <span class="token keyword keyword-interface">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Description</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
	<span class="token function">Call</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> input <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><p><strong>提示词模板（重点）</strong></p>
<p>和大模型交互的模板，大部分模型已经在预训练阶段都已经做过专门的适配，能够准确的理解和返回；</p>
<pre data-role="codeBlock" data-info="plaintext" class="language-plaintext plaintext"><code>Assistant is a large language model trained by Meta.

Assistant is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. As a language model, Assistant is able to generate human-like text based on the input it receives, allowing it to engage in natural-sounding conversations and provide responses that are coherent and relevant to the topic at hand.

Assistant is constantly learning and improving, and its capabilities are constantly evolving. It is able to process and understand large amounts of text, and can use this knowledge to provide accurate and informative responses to a wide range of questions. Additionally, Assistant is able to generate its own text based on the input it receives, allowing it to engage in discussions and provide explanations and descriptions on a wide range of topics.

Overall, Assistant is a powerful tool that can help with a wide range of tasks and provide valuable insights and information on a wide range of topics. Whether you need help with a specific question or just want to have a conversation about a particular topic, Assistant is here to assist.

TOOLS:
------

Assistant has access to the following tools:

{{.tool_descriptions}}
</code></pre><pre data-role="codeBlock" data-info="plaintext" class="language-plaintext plaintext"><code>To use a tool, please use the following format:

Thought: Do I need to use a tool? Yes
Action: the action to take, should be one of [{{.tool_names}}]
Action Input: the input to the action
Observation: the result of the action

When you have a response to say to the Human, or if you do not need to use a tool, you MUST use the format:

Thought: Do I need to use a tool? No
AI: [your response here]

</code></pre><pre data-role="codeBlock" data-info="plaintext" class="language-plaintext plaintext"><code>Begin!

Previous conversation history:
{{.history}}

New input: {{.input}}

Thought:{{.agent_scratchpad}}
</code></pre><p>模板占位符</p>
<table>
<thead>
<tr>
<th>占位符</th>
<th>填充逻辑</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>{{.tool_descriptions}}</td>
<td><code>tool.Name():&nbsp;tool.Description()</code></td>
<td>工具列表</td>
</tr>
<tr>
<td>{{.tool_names}}</td>
<td><code>tool.Name()</code></td>
<td>工具列表</td>
</tr>
<tr>
<td>{{.history}}</td>
<td><code>memory.LoadMemoryVariables()</code></td>
<td>上下文记忆</td>
</tr>
<tr>
<td>{{.input}}</td>
<td>用户输入</td>
<td></td>
</tr>
<tr>
<td>{{.agent_scratchpad}}</td>
<td>LLM前置步骤处理结果（思路）</td>
<td>工具返回结果</td>
</tr>
</tbody>
</table>
<p>返回格式（协议）</p>
<p>约定大模型推理返回的消息格式，代码根据约定的格式解析下一步执行的动作，具体格式定义在<code>conversational_format_instructions.txt</code>中，比如：</p>
<ul>
<li>文本返回：根据字符串前缀包含<code>AI:</code></li>
</ul>
<div class="admonition note">
<p class="admonition-title">模版</p>
<p>Do&nbsp;I&nbsp;need&nbsp;to&nbsp;use&nbsp;a&nbsp;tool?&nbsp;No</p>
<p>AI:&nbsp;"hello"</p>
</div>
<ul>
<li>工具调用：根据<strong>正则匹配</strong><code>Action</code>、<code>Action&nbsp;Input</code>关键词，<strong>确定需要执行的Tool及其参数</strong></li>
</ul>
<div class="admonition note">
<p class="admonition-title">模版</p>
<p>Do&nbsp;I&nbsp;need&nbsp;to&nbsp;use&nbsp;a&nbsp;tool?&nbsp;Yes</p>
<p>Action:&nbsp;计算工具</p>
<p>Action&nbsp;Input:&nbsp;hello</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>关于MCP的适配？</p>
<p>可以考虑在提示词模板、工具调用这里来适配</p>
<p>参考：<a href="https://github.com/langchain-ai/langchain-mcp-adapters">https://github.com/langchain-ai/langchain-mcp-adapters</a></p>
</div>
<p><strong>链式调用</strong></p>
<p>在需要调用工具的情况下，一般需要多次调用LLM来生成最终的返回，此流程通过链式调用的方式实现；</p>
<p><img src="./imges/image_4.png" alt="image"></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code>steps <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>schema<span class="token punctuation">.</span>AgentStep<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">// 链式调用结果</span>
<span class="token keyword keyword-for">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> e<span class="token punctuation">.</span>MaxIterations<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-var">var</span> finish <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>any
    <span class="token comment">// 循环调用</span>
    steps<span class="token punctuation">,</span> finish<span class="token punctuation">,</span> err <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">doIteration</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> steps<span class="token punctuation">,</span> nameToTool<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> finish <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-return">return</span> finish<span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><blockquote>
<p><a href="https://github.com/langgenius/dify/blob/main/api/core/agent/cot_agent_runner.py#L89">Dify实现</a></p>
</blockquote>
<h4 id="workflow">Workflow </h4>
<p><img src="./imges/image_3.png" alt="image.png"></p>
<p>工作流是通过预定义的代码路径来协调&nbsp;LLMs&nbsp;和工具的系统，Agent则是通过LLMs&nbsp;动态地控制自己的流程和工具使用，控制任务的完成。<a href="https://langchain-ai.github.io/langgraph/tutorials/workflows/">参考</a></p>
<h5 id="工程实现-2">工程实现 </h5>
<p>:::<br>
参考的是<a href="https://github.com/langgenius/dify/blob/main/api/core/workflow/graph_engine/graph_engine.py#L146">Dify</a>，其他的框架可以参考<a href="https://github.com/langchain-ai/langgraph/blob/062253fe483f041cf7556bcffecb2216412d315f/libs/langgraph/langgraph/pregel/__init__.py#L2181C9-L2181C15">langgraph</a>、aimap，大部分都是基于流程引擎来实现的；<br>
:::</p>
<p><strong>图（Graph）定义</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code>class <span class="token function">Graph</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    root_node_id<span class="token punctuation">:</span> str <span class="token operator">=</span> <span class="token function">Field</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"root node id of the graph"</span><span class="token punctuation">)</span>
    node_ids<span class="token punctuation">:</span> list<span class="token punctuation">[</span>str<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Field</span><span class="token punctuation">(</span>default_factory<span class="token operator">=</span>list<span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"graph node ids"</span><span class="token punctuation">)</span>
    node_id_config_mapping<span class="token punctuation">:</span> dict<span class="token punctuation">[</span>str<span class="token punctuation">,</span> dict<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Field</span><span class="token punctuation">(</span>
        default_factory<span class="token operator">=</span>list<span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"node configs mapping (node id: node config)"</span>
    <span class="token punctuation">)</span>
    edge_mapping<span class="token punctuation">:</span> dict<span class="token punctuation">[</span>str<span class="token punctuation">,</span> list<span class="token punctuation">[</span>GraphEdge<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Field</span><span class="token punctuation">(</span>
        default_factory<span class="token operator">=</span>dict<span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"graph edge mapping (source node id: edges)"</span>
    <span class="token punctuation">)</span>
</code></pre><p><strong>节点（Node）</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code>class <span class="token function">BaseNode</span><span class="token punctuation">(</span>Generic<span class="token punctuation">[</span>GenericNodeData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
@abstractmethod
    def <span class="token function">_run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> NodeRunResult <span class="token operator">|</span> Generator<span class="token punctuation">[</span>Union<span class="token punctuation">[</span>NodeEvent<span class="token punctuation">,</span> <span class="token string">"InNodeEvent"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> None<span class="token punctuation">,</span> None<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token string">""</span>"
        Run node
        <span class="token punctuation">:</span><span class="token keyword keyword-return">return</span><span class="token punctuation">:</span>
        <span class="token string">""</span>"
        raise NotImplementedError
</code></pre><p>各类型节点实现：</p>
<p><a href="https://github.com/langgenius/dify/tree/main/api/core/workflow/nodes">https://github.com/langgenius/dify/tree/main/api/core/workflow/nodes:&nbsp;https://github.com/langgenius/dify/tree/main/api/core/workflow/nodes</a></p>
<p><strong>边（GraphEdge）</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">GraphEdge</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    source_node_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"source node id"</span><span class="token punctuation">)</span>
    target_node_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"target node id"</span><span class="token punctuation">)</span>
    run_condition<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>RunCondition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token triple-quoted-string string">"""run condition"""</span>
</code></pre><p><strong>流程引擎（Engine）</strong></p>
<p class="plantuml"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentstyletype="text/css" data-diagram-type="SEQUENCE" height="444px" preserveAspectRatio="none" style="width:391px;height:444px;background:#FFFFFF;" version="1.1" viewBox="0 0 391 444" width="391px" zoomAndPan="magnify"><defs></defs><g><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="265.0757" x="22.7051" y="226.041"></rect><rect fill="none" height="105.2422" style="stroke:#000000;stroke-width:1.5;" width="363.0815" x="22.7051" y="286.6621"></rect><g><title>GraphEngine</title><rect fill="#000000" fill-opacity="0.00000" height="372.416" width="8" x="79.0142" y="36.4883"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="82.7051" x2="82.7051" y1="36.4883" y2="408.9043"></line></g><g><title>Node</title><rect fill="#000000" fill-opacity="0.00000" height="372.416" width="8" x="249.0039" y="36.4883"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="252.2271" x2="252.2271" y1="36.4883" y2="408.9043"></line></g><g><title>GraphEdge</title><rect fill="#000000" fill-opacity="0.00000" height="372.416" width="8" x="327.7837" y="36.4883"></rect><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="331.7808" x2="331.7808" y1="36.4883" y2="408.9043"></line></g><g class="participant participant-head" data-participant="GraphEngine"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100.6182" x="32.7051" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86.6182" x="39.7051" y="25.5352">GraphEngine</text></g><g class="participant participant-tail" data-participant="GraphEngine"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100.6182" x="32.7051" y="407.9043"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86.6182" x="39.7051" y="428.4395">GraphEngine</text></g><g class="participant participant-head" data-participant="Node"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="49.5537" x="228.2271" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35.5537" x="235.2271" y="25.5352">Node</text></g><g class="participant participant-tail" data-participant="Node"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="49.5537" x="228.2271" y="407.9043"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35.5537" x="235.2271" y="428.4395">Node</text></g><g class="participant participant-head" data-participant="GraphEdge"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88.0059" x="287.7808" y="5"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74.0059" x="294.7808" y="25.5352">GraphEdge</text></g><g class="participant participant-tail" data-participant="GraphEdge"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="88.0059" x="287.7808" y="407.9043"></rect><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74.0059" x="294.7808" y="428.4395">GraphEdge</text></g><g class="message" data-participant-1="GraphEngine" data-participant-2="GraphEngine"><polygon fill="#181818" points="71.0142,63.7988,81.0142,67.7988,71.0142,71.7988,75.0142,67.7988" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="0" x2="77.0142" y1="67.7988" y2="67.7988"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59.0142" x="7" y="63.0566">初始Node</text></g><g class="message" data-participant-1="GraphEngine" data-participant-2="GraphEngine"><line style="stroke:#181818;stroke-width:1;" x1="83.0142" x2="125.0142" y1="97.1094" y2="97.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="125.0142" x2="125.0142" y1="97.1094" y2="110.1094"></line><line style="stroke:#181818;stroke-width:1;" x1="84.0142" x2="125.0142" y1="110.1094" y2="110.1094"></line><polygon fill="#181818" points="94.0142,106.1094,84.0142,110.1094,94.0142,114.1094,90.0142,110.1094" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116.4414" x="90.0142" y="92.3672">加载node_instance</text></g><g class="message" data-participant-1="GraphEngine" data-participant-2="Node"><polygon fill="#181818" points="241.0039,135.4199,251.0039,139.4199,241.0039,143.4199,245.0039,139.4199" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="83.0142" x2="247.0039" y1="139.4199" y2="139.4199"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.4648" x="90.0142" y="134.6777">node_instance.run()</text></g><g class="message" data-participant-1="Node" data-participant-2="GraphEngine"><polygon fill="#181818" points="94.0142,164.7305,84.0142,168.7305,94.0142,172.7305,90.0142,168.7305" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="88.0142" x2="252.0039" y1="168.7305" y2="168.7305"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="142.1621" x="100.0142" y="163.9883">节点执行结果NodeState</text></g><g class="message" data-participant-1="GraphEngine" data-participant-2="GraphEngine"><line style="stroke:#181818;stroke-width:1;" x1="83.0142" x2="125.0142" y1="198.041" y2="198.041"></line><line style="stroke:#181818;stroke-width:1;" x1="125.0142" x2="125.0142" y1="198.041" y2="211.041"></line><line style="stroke:#181818;stroke-width:1;" x1="84.0142" x2="125.0142" y1="211.041" y2="211.041"></line><polygon fill="#181818" points="94.0142,207.041,84.0142,211.041,94.0142,215.041,90.0142,211.041" style="stroke:#181818;stroke-width:1;"></polygon><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82.5767" x="90.0142" y="193.2988">加载Edge配置</text></g><path d="M22.7051,226.041 L84.8438,226.041 L84.8438,233.3516 L74.8438,243.3516 L22.7051,243.3516 L22.7051,226.041" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:1.5;" width="265.0757" x="22.7051" y="226.041"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="37.7051" y="239.6094">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="41.1533" x="99.8438" y="238.6758">[一条边]</text><g class="message" data-participant-1="GraphEngine" data-participant-2="Node"><polygon fill="#181818" points="241.0039,260.6621,251.0039,264.6621,241.0039,268.6621,245.0039,264.6621" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="83.0142" x2="247.0039" y1="264.6621" y2="264.6621"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145.9897" x="90.0142" y="259.9199">执行target_node_id节点</text></g><path d="M22.7051,286.6621 L84.8438,286.6621 L84.8438,293.9727 L74.8438,303.9727 L22.7051,303.9727 L22.7051,286.6621" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"></path><rect fill="none" height="105.2422" style="stroke:#000000;stroke-width:1.5;" width="363.0815" x="22.7051" y="286.6621"></rect><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17.1387" x="37.7051" y="300.2305">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="93.3066" x="99.8438" y="299.2969">[多条边(条件判断)]</text><g class="message" data-participant-1="GraphEngine" data-participant-2="GraphEdge"><polygon fill="#181818" points="319.7837,321.2832,329.7837,325.2832,319.7837,329.2832,323.7837,325.2832" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="83.0142" x2="325.7837" y1="325.2832" y2="325.2832"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="200.2368" x="90.0142" y="320.541">run_condition.check(NodeState)</text></g><g class="message" data-participant-1="GraphEdge" data-participant-2="GraphEngine"><polygon fill="#181818" points="94.0142,350.5938,84.0142,354.5938,94.0142,358.5938,90.0142,354.5938" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="88.0142" x2="330.7837" y1="354.5938" y2="354.5938"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93.9897" x="100.0142" y="349.8516">target_node_id</text></g><g class="message" data-participant-1="GraphEngine" data-participant-2="Node"><polygon fill="#181818" points="241.0039,379.9043,251.0039,383.9043,241.0039,387.9043,245.0039,383.9043" style="stroke:#181818;stroke-width:1;"></polygon><line style="stroke:#181818;stroke-width:1;" x1="83.0142" x2="247.0039" y1="383.9043" y2="383.9043"></line><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145.9897" x="90.0142" y="379.1621">执行target_node_id节点</text></g><!--SRC=[YzQrSozABCXmpKlFp4krKdZQCVVfycw__9HKBYua2GLTEmLKTLqBNkpTcmTK5v-PLroIc9UCgG5aYfK2YXgzej8y3Kqka8o2BhgPBxgQdZVjVDQv_CN2dkUx9p-RDmUaBhWaiOGenxYcfAU-RErzldST5rTYJed2anqDp-OkVB5l9mw7GImgIInAJos9XxWo1U84BgxKl1I88K-Np88OeW6adkpUzhHZoRDfQpMnEmVe02i5e0_Za_FpKZ9BClFpz98pKfEpDU3-W6a4giJm1QfBI7OpqCa0]--></g></svg></p><pre data-role="codeBlock" data-info="python" class="language-python python"><code>next_node_id <span class="token operator">=</span> start_node_id

<span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
  node_config <span class="token operator">=</span> self<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>node_id_config_mapping<span class="token punctuation">.</span>get<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>
  node_instance <span class="token operator">=</span> node_cls<span class="token punctuation">(</span>node_config<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  _run_node<span class="token punctuation">(</span>node_instance<span class="token punctuation">)</span>
  generator <span class="token operator">=</span> node_instance<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
  edge_mappings <span class="token operator">=</span> self<span class="token punctuation">.</span>graph<span class="token punctuation">.</span>edge_mapping<span class="token punctuation">.</span>get<span class="token punctuation">(</span>next_node_id<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>edge_mappings<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token operator">//</span> 非条件
  <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
    <span class="token operator">//</span> 条件判断
    <span class="token keyword keyword-if">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>run_condition <span class="token keyword keyword-for">for</span> edge <span class="token keyword keyword-in">in</span> edge_mappings<span class="token punctuation">)</span><span class="token punctuation">:</span>

</code></pre><blockquote>
<p>源码实现：<a href="https://github.com/langgenius/dify/blob/main/api/core/workflow/graph_engine/graph_engine.py#L224">‎GraphEngine._run</a></p>
</blockquote>
<h4 id="其他基础能力">其他基础能力 </h4>
<p>比如RAG、工具、日志、应用发布等配套的能力；</p>
<h3 id="流程建设llmops">流程建设（LLMOps） </h3>
<p><strong>LLMOps</strong>：涵盖了大型语言模型（如GPT系列）<strong>开发、部署、维护和优化的一整套实践和流程</strong>；LLMOps&nbsp;的目标是确保高效、可扩展和安全地使用这些强大的&nbsp;AI&nbsp;模型来构建和运行实际应用程序。它涉及到模型训练、部署、监控、更新、安全性和合规性等方面；</p>
<p><img src="./imges/image_2.png" alt="image.png"></p>
<blockquote>
<p><a href="https://www.databricks.com/glossary/llmops">https://www.databricks.com/glossary/llmops</a></p>
</blockquote>
<h2 id="附录">附录 </h2>
<p>开源仓库：</p>
<p>机器学习专业术语：<a href="https://developers.google.com/machine-learning/glossary/fundamentals?hl=zh-cn">https://developers.google.com/machine-learning/glossary/fundamentals?hl=zh-cn</a></p>
<p>文档：</p>
<p><a href="https://github.com/liguodongiot/llm-action">https://github.com/liguodongiot/llm-action</a></p>
<p><a href="https://github.com/luhengshiwo/LLMForEverybody">https://github.com/luhengshiwo/LLMForEverybody</a></p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>